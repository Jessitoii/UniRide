generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  email          String   @unique
  password       String
  name           String
  surname        String
  gender         String
  birthDate      DateTime
  university     String
  faculty        String
  stars          Float      @default(5.0)
  bio            String?
  posts          Post[]   @relation("PostUser") // Relation to Post
  interestedIn   InterestedUser[] // Relation to UserPost join model
  matchedPosts   Post[]   @relation("MatchedUser") // Reverse relation to Post
  reviewMade     Review[] @relation("Commenter") // Comments made by the user
  reviewReceived Review[] @relation("CommentedUser") // Comments received by the user
  messagesSent   Message[] @relation("MessageSender") // Messages sent by the user
  messagesReceived Message[] @relation("MessageReceiver") // Messages received by the user
  blockedUsers   BlockList[] @relation("Blocker")
  blockedBy      BlockList[] @relation("Blocked")
  carId          String?  @map("car_id")
  car            Car?     @relation("CarUser")
  
  emailNotifications Boolean @default(false)
  pushNotifications  Boolean @default(false)
  notificationsEnabled Boolean @default(true)
  appAlerts          Boolean @default(false)
  locationFeatures   Boolean @default(false)
  locationAccess     Boolean @default(false)
  hasCustomPhoto     Boolean @default(false)

  lastSeen           DateTime? @default(now())
  createdAt      DateTime @default(now())
  shortcuts      Shortcut[]

  @@map("users")
}

model Shortcut {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  label     String
  address   String
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("shortcuts")
}

model ValidationCode {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  tempPassword   String?
  tempName       String?
  tempSurname    String?
  tempGender     String?
  tempBirthDate  DateTime?
  tempUniversity String?
  tempFaculty    String?
}

model Post {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                  String   @map("user_id") // Foreign key to User
  user                    User     @relation("PostUser", fields: [userId], references: [id]) // Relation to User
  sourceAddress           String
  sourceCoordinates       String  // Nullable field
  destinationUniversity   String
  destinationFaculty      String
  route                   String   // This could be a JSON or a more complex type if needed
  datetimeStart           DateTime
  datetimeEnd             DateTime

  interestedUsers         InterestedUser[] // Relation to UserPost join model
  matchedUserId           String?   @map("matched_user_id") // Foreign key to User, optional
  matchedUser             User?     @relation("MatchedUser", fields: [matchedUserId], references: [id]) // Relation to User
  reviews                 Review[] // Reviews related to this post
  status                  String    @default("PENDING") // PENDING, MATCHED, COMPLETED, CANCELLED, EXPIRED
  createdAt               DateTime  @default(now())
}

model InterestedUser {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  postId    String
  locationCoordinates String
  user      User   @relation(fields: [userId], references: [id])
  post      Post?   @relation(fields: [postId], references: [id])
  createdAt DateTime? @default(now())
  @@map("user_posts")
}

model Review {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @map("user_id") // Foreign key to User who made the comment
  reviewedUserId String  @map("commented_user_id") // Foreign key to User who received the comment
  postId         String?  @map("post_id") @db.ObjectId // Optional relation to the ride
  star           Int      @default(0) @db.Int // Star rating (0-5)
  comment        String?
  createdAt      DateTime @default(now())
  
  user           User     @relation("Commenter", fields: [userId], references: [id]) // Relation to User who made the comment
  reviewedUser  User     @relation("CommentedUser", fields: [reviewedUserId], references: [id]) // Relation to User who received the comment
  post           Post?    @relation(fields: [postId], references: [id])

  @@map("reviews")
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  rideId    String   @map("ride_id") // Changed from roomId to rideId based on requirements, but often rideId == roomId
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])
  senderId  String   @map("sender_id")
  receiver  User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  receiverId String  @map("receiver_id")
  text      String
  timestamp DateTime @default(now())
  status    MessageStatus @default(SENT)

  @@index([rideId])
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

model Car {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  brand     String
  model     String
  userId    String   @unique @map("user_id") // Foreign key to User
  user      User     @relation("CarUser", fields: [userId], references: [id])
  photoPath String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}



// Define notification types
enum NotificationType {
  ride
  match
  system
}

// Define reference model types
enum ReferenceModel {
  Post
  User
  Review
}

// Notification model
model Notification {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  userId      String          @db.ObjectId
  type        NotificationType
  title       String
  message     String
  isRead      Boolean         @default(false)
  relatedId   String?         @db.ObjectId
  refModel    ReferenceModel?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  
  // Optional polymorphic relations 
  // (You'll need to uncomment and adjust based on your schema)
  // post        Post?           @relation(fields: [relatedId], references: [id])
  // relatedUser User?           @relation("RelatedToUser", fields: [relatedId], references: [id])
  // payment     Payment?        @relation(fields: [relatedId], references: [id])

  @@index([userId])
  @@index([relatedId])
  @@map("notifications")
}

model BlockList {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  blockerId String   @map("blocker_id")
  blockedId String   @map("blocked_id")
  timestamp DateTime @default(now())

  blocker   User     @relation("Blocker", fields: [blockerId], references: [id])
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
  @@map("block_list")
}