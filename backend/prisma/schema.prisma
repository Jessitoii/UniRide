generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  email          String   @unique
  password       String
  name           String
  surname        String
  gender         String
  birthDate      DateTime
  university     String
  faculty        String
  stars          Float      @default(5.0)
  bio            String?
  posts          Post[]   @relation("PostUser") // Relation to Post
  interestedIn   InterestedUser[] // Relation to UserPost join model
  matchedPosts   Post[]   @relation("MatchedUser") // Reverse relation to Post
  reviewMade     Review[] @relation("Commenter") // Comments made by the user
  reviewReceived Review[] @relation("CommentedUser") // Comments received by the user
  messagesSent   Message[] @relation("MessageSender") // Messages sent by the user
  messagesReceived Message[] @relation("MessageReceiver") // Messages received by the user
  carId          String?  @map("car_id")
  car            Car?     @relation("CarUser")
  wallet         Wallet?  @relation("UserWallet")
  walletId       String?  @map("wallet_id")
  iban           String? // IBAN for driver, nullable
  createdAt      DateTime @default(now())
  @@map("users")
}

model ValidationCode {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Post {
  id                      String   @id @default(auto()) @map("_id") @db.ObjectId
  userId                  String   @map("user_id") // Foreign key to User
  user                    User     @relation("PostUser", fields: [userId], references: [id]) // Relation to User
  sourceAddress           String
  sourceCoordinates       String  // Nullable field
  destinationUniversity   String
  destinationFaculty      String
  route                   String   // This could be a JSON or a more complex type if needed
  datetimeStart           DateTime
  datetimeEnd             DateTime
  price                   Float
  fare                    Float // Payment amount for the ride
  interestedUsers         InterestedUser[] // Relation to UserPost join model
  matchedUserId           String?   @map("matched_user_id") // Foreign key to User, optional
  matchedUser             User?     @relation("MatchedUser", fields: [matchedUserId], references: [id]) // Relation to User
  createdAt               DateTime  @default(now())
}

model InterestedUser {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  userId    String
  postId    String
  locationCoordinates String
  user      User   @relation(fields: [userId], references: [id])
  post      Post?   @relation(fields: [postId], references: [id])
  @@map("user_posts")
}

model Review {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @map("user_id") // Foreign key to User who made the comment
  reviewedUserId String  @map("commented_user_id") // Foreign key to User who received the comment
  star           Int      @default(0) @db.Int // Star rating (0-5)
  comment        String   // Comment text
  createdAt      DateTime @default(now())
  
  user           User     @relation("Commenter", fields: [userId], references: [id]) // Relation to User who made the comment
  reviewedUser  User     @relation("CommentedUser", fields: [reviewedUserId], references: [id]) // Relation to User who received the comment
}

model Message {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  roomId    String
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])
  senderId  String  @map("sender_id")
  receiver  User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  receiverId String  @map("receiver_id")
  text      String
  timestamp DateTime @default(now())

  @@index([roomId])
}

model Car {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  brand     String
  model     String
  userId    String   @unique @map("user_id") // Foreign key to User
  user      User     @relation("CarUser", fields: [userId], references: [id])
  photoPath String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Wallet {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @unique @map("user_id")
  user            User?    @relation("UserWallet", fields: [userId], references: [id])
  depositBalance  Float    @default(0.0)
  earningsBalance Float    @default(0.0)
  transactions    Transaction[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Transaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  walletId  String   @map("wallet_id")
  type      String   // 'deposit', 'withdraw', 'spend'
  amount    Float
  createdAt DateTime @default(now())
  wallet    Wallet   @relation(fields: [walletId], references: [id])
}

// Define notification types
enum NotificationType {
  ride
  match
  payment
  system
}

// Define reference model types
enum ReferenceModel {
  Post
  User
  Payment
}

// Notification model
model Notification {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  userId      String          @db.ObjectId
  type        NotificationType
  title       String
  message     String
  isRead      Boolean         @default(false)
  relatedId   String?         @db.ObjectId
  refModel    ReferenceModel?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  
  // Optional polymorphic relations 
  // (You'll need to uncomment and adjust based on your schema)
  // post        Post?           @relation(fields: [relatedId], references: [id])
  // relatedUser User?           @relation("RelatedToUser", fields: [relatedId], references: [id])
  // payment     Payment?        @relation(fields: [relatedId], references: [id])

  @@index([userId])
  @@index([relatedId])
  @@map("notifications")
}